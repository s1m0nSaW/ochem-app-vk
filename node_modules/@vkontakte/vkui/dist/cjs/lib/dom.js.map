{"version":3,"sources":["../../../src/lib/dom.tsx"],"sourcesContent":["import * as React from 'react';\nimport { canUseDOM } from '@vkontakte/vkjs';\nimport { rectToClientRect } from '@vkontakte/vkui-floating-ui/core';\nimport {\n  getNearestOverflowAncestor as getNearestOverflowAncestorLib,\n  getWindow,\n  isElement,\n  isHTMLElement,\n} from '@vkontakte/vkui-floating-ui/utils/dom';\n\nexport {\n  getWindow,\n  getNodeScroll,\n  isHTMLElement,\n  isElement,\n} from '@vkontakte/vkui-floating-ui/utils/dom';\n\nexport { canUseDOM, canUseEventListeners, onDOMLoaded } from '@vkontakte/vkjs';\nexport interface DOMContextInterface {\n  /**\n   * @ignore\n   */\n  window?: Window;\n  /**\n   * @ignore\n   */\n  document?: Document;\n}\n\nexport type DOMProps = DOMContextInterface;\n\n/* eslint-disable no-restricted-globals */\nexport const getDOM = () => ({\n  window: canUseDOM ? window : undefined,\n  document: canUseDOM ? document : undefined,\n});\n/* eslint-enable no-restricted-globals */\n\nexport const DOMContext = React.createContext<DOMContextInterface>(getDOM());\n\nexport const useDOM = () => {\n  return React.useContext(DOMContext);\n};\n\n/**\n * В случае, если используется DOMContext, при проверке 'node instanceOf Window' – Window может быть\n * другим объектом.\n */\nexport const isWindow = (\n  node: Element | Window | VisualViewport | undefined | null,\n): node is Window => {\n  return node !== null && node !== undefined && 'navigator' in node;\n};\n\nexport const isBody = (\n  node: Element | Window | VisualViewport | undefined | null,\n): node is HTMLBodyElement => {\n  return node !== null && node !== undefined && 'tagName' in node && node.tagName === 'BODY';\n};\n\nexport function withDOM<Props>(\n  Component: React.ComponentType<Props & DOMProps>,\n): React.ComponentType<Props> {\n  const WithDOM = (props: Props) => {\n    const dom = useDOM();\n    return <Component {...props} {...dom} />;\n  };\n  return WithDOM;\n}\n\nexport function blurActiveElement(document: Document | undefined) {\n  if (document && document.activeElement) {\n    (document.activeElement as HTMLElement).blur();\n  }\n}\n\nexport const TRANSFORM_DEFAULT_VALUES = ['none', 'initial', 'inherit', 'unset'];\nexport const WILL_CHANGE_DEFAULT_VALUES = ['auto', 'initial', 'inherit', 'unset'];\nexport function getTransformedParentCoords(element: Element) {\n  let parentNode = element.parentNode;\n  while (parentNode !== null) {\n    if (isHTMLElement(parentNode)) {\n      const { transform, willChange } = getComputedStyle(parentNode);\n      if (\n        !TRANSFORM_DEFAULT_VALUES.includes(transform) ||\n        !WILL_CHANGE_DEFAULT_VALUES.includes(willChange)\n      ) {\n        const { x, y } = parentNode.getBoundingClientRect();\n        return { x, y };\n      }\n    }\n    parentNode = parentNode.parentNode;\n  }\n  return { x: 0, y: 0 };\n}\n\nexport const getBoundingClientRect = (node: Element | Window, isFixedStrategy = false) => {\n  const element = isWindow(node) ? node.document.documentElement : node;\n  const clientRect = element.getBoundingClientRect();\n\n  let offsetX = 0;\n  let offsetY = 0;\n  if (isFixedStrategy) {\n    const { x, y } = getTransformedParentCoords(element);\n    offsetX = x;\n    offsetY = y;\n  }\n\n  return rectToClientRect({\n    x: clientRect.left - offsetX,\n    y: clientRect.top - offsetY,\n    width: clientRect.width,\n    height: clientRect.height,\n  }) as DOMRect;\n};\n\n/**\n * Адаптер над getNearestOverflowAncestor из @floating-ui/utils/dom.\n *\n * document.body подменяем на window, т.к. на document.body нельзя применить скролл.\n */\nexport const getNearestOverflowAncestor = (childEl: Node): HTMLElement | Window | null => {\n  const foundAncestor = getNearestOverflowAncestorLib(childEl);\n\n  return isBody(foundAncestor)\n    ? getWindow(foundAncestor)\n    : isHTMLElement(childEl)\n    ? foundAncestor\n    : null;\n};\n\nexport const getScrollHeight = (node: Element | Window) => {\n  return isWindow(node) ? node.document.documentElement.scrollHeight : node.scrollHeight;\n};\n\nexport const getScrollRect = (node: Element | Window) => {\n  const window = isElement(node) ? getWindow(node) : node;\n  const scrollElRect = getBoundingClientRect(node);\n\n  const edgeTop = window.scrollY + scrollElRect.top;\n  const edgeBottom = edgeTop + scrollElRect.height;\n  const y: [number, number] = [edgeTop, edgeBottom];\n\n  return {\n    relative: scrollElRect,\n    edges: { y },\n  };\n};\n\nexport const getDocumentBody = (node?: any) => getWindow(node).document.body;\n\nexport const getActiveElementByAnotherElement = (el: Element | null) =>\n  el ? el.ownerDocument.activeElement : null;\n\nexport const contains = (parent?: Element | null, child?: Element | null) => {\n  return parent && child ? parent.contains(child) : false;\n};\n"],"names":["DOMContext","TRANSFORM_DEFAULT_VALUES","WILL_CHANGE_DEFAULT_VALUES","blurActiveElement","canUseDOM","canUseEventListeners","contains","getActiveElementByAnotherElement","getBoundingClientRect","getDOM","getDocumentBody","getNearestOverflowAncestor","getNodeScroll","getScrollHeight","getScrollRect","getTransformedParentCoords","getWindow","isBody","isElement","isHTMLElement","isWindow","onDOMLoaded","useDOM","withDOM","window","undefined","document","React","createContext","useContext","node","tagName","Component","WithDOM","props","dom","activeElement","blur","element","parentNode","transform","willChange","getComputedStyle","includes","x","y","isFixedStrategy","documentElement","clientRect","offsetX","offsetY","rectToClientRect","left","top","width","height","childEl","foundAncestor","getNearestOverflowAncestorLib","scrollHeight","scrollElRect","edgeTop","scrollY","edgeBottom","relative","edges","body","el","ownerDocument","parent","child"],"mappings":"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"}