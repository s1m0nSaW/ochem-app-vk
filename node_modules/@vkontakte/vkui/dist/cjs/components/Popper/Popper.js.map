{"version":3,"sources":["../../../../src/components/Popper/Popper.tsx"],"sourcesContent":["import * as React from 'react';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { usePrevious } from '../../hooks/usePrevious';\nimport {\n  autoUpdateFloatingElement,\n  convertFloatingDataToReactCSSProperties,\n  type FloatingComponentProps,\n  type Placement,\n  useFloating,\n  useFloatingMiddlewaresBootstrap,\n  type VirtualElement,\n} from '../../lib/floating';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport type { HTMLAttributesWithRootRef } from '../../types';\nimport { AppRootPortal } from '../AppRoot/AppRootPortal';\nimport {\n  DEFAULT_ARROW_HEIGHT,\n  DEFAULT_ARROW_PADDING,\n  DefaultIcon,\n} from '../FloatingArrow/DefaultIcon';\nimport {\n  FloatingArrow,\n  type FloatingArrowProps as FloatingArrowPropsPrivate,\n} from '../FloatingArrow/FloatingArrow';\nimport { RootComponent } from '../RootComponent/RootComponent';\nimport styles from './Popper.module.css';\n\nexport type FloatingArrowProps = Omit<\n  FloatingArrowPropsPrivate,\n  'getRootRef' | 'coords' | 'placement' | 'Icon'\n>;\n\ntype AllowedFloatingComponentProps = Pick<\n  FloatingComponentProps,\n  | 'arrow'\n  | 'arrowRef'\n  | 'arrowHeight'\n  | 'arrowPadding'\n  | 'hoverDelay'\n  | 'placement'\n  | 'offsetByMainAxis'\n  | 'offsetByCrossAxis'\n  | 'shown'\n  | 'onShownChange'\n  | 'defaultShown'\n  | 'hideWhenReferenceHidden'\n  | 'sameWidth'\n  | 'zIndex'\n  | 'usePortal'\n  | 'customMiddlewares'\n>;\n\nexport interface PopperCommonProps\n  extends AllowedFloatingComponentProps,\n    Omit<HTMLAttributesWithRootRef<HTMLDivElement>, keyof AllowedFloatingComponentProps> {\n  /**\n   * Позволяет набросить на стрелку пользовательские атрибуты.\n   */\n  arrowProps?: FloatingArrowProps;\n  /**\n   * Пользовательская SVG иконка.\n   *\n   * Требования:\n   *\n   * 1. Иконка по умолчанию должна быть направлена вверх (a.k.a `IconUp`).\n   * 2. Чтобы избежать проблемы с пространством между стрелкой и контентом на некоторых экранах,\n   *    растяните кривую по высоте на `1px` и увеличьте на этот размер `height` и `viewBox` SVG.\n   *    (см. https://github.com/VKCOM/VKUI/pull/4496).\n   * 3. Передайте высоту иконки в параметр `arrowHeight`. В значении высоты можно исключить хак с `1px` из п.2.\n   * 4. Убедитесь, что компонент принимает все валидные для SVG параметры.\n   * 5. Убедитесь, что SVG и её элементы наследует цвет через `fill=\"currentColor\"`.\n   */\n  ArrowIcon?: FloatingArrowPropsPrivate['Icon'];\n  /**\n   * Подписывается на изменение геометрии `targetRef`, чтобы пересчитать свою позицию.\n   */\n  autoUpdateOnTargetResize?: boolean;\n  /**\n   * В зависимости от области видимости, позиция может смениться на более оптимальную,\n   * чтобы Popper вместился в эту область видимости.\n   */\n  onPlacementChange?(placement: Placement): void;\n}\n\nexport interface PopperProps extends PopperCommonProps {\n  targetRef: React.RefObject<HTMLElement> | VirtualElement;\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/Popper\n */\nexport const Popper = ({\n  // UseFloatingMiddlewaresBootstrapProps\n  placement: placementProp = 'bottom-start',\n  sameWidth,\n  hideWhenReferenceHidden,\n  offsetByMainAxis = 8,\n  offsetByCrossAxis = 0,\n  arrow,\n  arrowHeight = DEFAULT_ARROW_HEIGHT,\n  arrowPadding = DEFAULT_ARROW_PADDING,\n  customMiddlewares,\n\n  // UseFloatingProps\n  autoUpdateOnTargetResize = false,\n\n  // ArrowProps\n  arrowProps,\n  ArrowIcon = DefaultIcon,\n\n  // rest\n  targetRef,\n  getRootRef,\n  children,\n  usePortal = true,\n  style: styleProp,\n  onPlacementChange,\n  ...restProps\n}: PopperProps) => {\n  const [arrowRef, setArrowRef] = React.useState<HTMLDivElement | null>(null);\n\n  const { strictPlacement, middlewares } = useFloatingMiddlewaresBootstrap({\n    placement: placementProp,\n    sameWidth,\n    arrow,\n    arrowRef,\n    arrowHeight,\n    arrowPadding,\n    offsetByMainAxis,\n    offsetByCrossAxis,\n    hideWhenReferenceHidden,\n    customMiddlewares,\n  });\n\n  const {\n    x: floatingDataX,\n    y: floatingDataY,\n    strategy: floatingPositionStrategy,\n    placement: resolvedPlacement,\n    refs,\n    middlewareData,\n  } = useFloating({\n    placement: strictPlacement,\n    middleware: middlewares,\n    whileElementsMounted(...args) {\n      /* istanbul ignore next: не знаю как проверить */\n      return autoUpdateFloatingElement(...args, {\n        elementResize: autoUpdateOnTargetResize,\n      });\n    },\n  });\n  const { arrow: arrowCoords } = middlewareData;\n\n  const handleRootRef = useExternRef<HTMLDivElement>(refs.setFloating, getRootRef);\n\n  useIsomorphicLayoutEffect(() => {\n    refs.setReference('current' in targetRef ? targetRef.current : targetRef);\n  }, [refs.setReference, targetRef]);\n\n  const prevResolvedPlacement = usePrevious(resolvedPlacement);\n  useIsomorphicLayoutEffect(() => {\n    if (prevResolvedPlacement === undefined || !onPlacementChange) {\n      return;\n    }\n    if (prevResolvedPlacement !== resolvedPlacement) {\n      onPlacementChange(resolvedPlacement);\n    }\n  }, [prevResolvedPlacement, resolvedPlacement, onPlacementChange]);\n\n  const dropdown = (\n    <RootComponent\n      {...restProps}\n      baseClassName={styles['Popper']}\n      getRootRef={handleRootRef}\n      style={{\n        ...styleProp,\n        ...convertFloatingDataToReactCSSProperties(\n          floatingPositionStrategy,\n          floatingDataX,\n          floatingDataY,\n          sameWidth ? null : undefined,\n          middlewareData,\n        ),\n      }}\n    >\n      {arrow && (\n        <FloatingArrow\n          {...arrowProps}\n          coords={arrowCoords}\n          placement={resolvedPlacement}\n          getRootRef={setArrowRef}\n          Icon={ArrowIcon}\n        />\n      )}\n      {children}\n    </RootComponent>\n  );\n\n  return <AppRootPortal usePortal={usePortal}>{dropdown}</AppRootPortal>;\n};\n"],"names":["Popper","placement","placementProp","sameWidth","hideWhenReferenceHidden","offsetByMainAxis","offsetByCrossAxis","arrow","arrowHeight","DEFAULT_ARROW_HEIGHT","arrowPadding","DEFAULT_ARROW_PADDING","customMiddlewares","autoUpdateOnTargetResize","arrowProps","ArrowIcon","DefaultIcon","targetRef","getRootRef","children","usePortal","style","styleProp","onPlacementChange","restProps","arrowRef","setArrowRef","React","useState","strictPlacement","middlewares","useFloatingMiddlewaresBootstrap","x","floatingDataX","y","floatingDataY","strategy","floatingPositionStrategy","resolvedPlacement","refs","middlewareData","useFloating","middleware","whileElementsMounted","args","autoUpdateFloatingElement","elementResize","arrowCoords","handleRootRef","useExternRef","setFloating","useIsomorphicLayoutEffect","setReference","current","prevResolvedPlacement","usePrevious","undefined","dropdown","RootComponent","baseClassName","convertFloatingDataToReactCSSProperties","FloatingArrow","coords","Icon","AppRootPortal"],"mappings":";;;;+BA2FaA;;;eAAAA;;;;;;;iEA3FU;8BACM;6BACD;0BASrB;2CACmC;+BAEZ;6BAKvB;+BAIA;+BACuB;AAmEvB,MAAMA,SAAS;QAAC,EACrB,uCAAuC;IACvCC,WAAWC,gBAAgB,cAAc,EACzCC,SAAS,EACTC,uBAAuB,EACvBC,mBAAmB,CAAC,EACpBC,oBAAoB,CAAC,EACrBC,KAAK,EACLC,cAAcC,iCAAoB,EAClCC,eAAeC,kCAAqB,EACpCC,iBAAiB,EAEjB,mBAAmB;IACnBC,2BAA2B,KAAK,EAEhC,aAAa;IACbC,UAAU,EACVC,YAAYC,wBAAW,EAEvB,OAAO;IACPC,SAAS,EACTC,UAAU,EACVC,QAAQ,EACRC,YAAY,IAAI,EAChBC,OAAOC,SAAS,EAChBC,iBAAiB,EAEL,WADTC;QAxBHvB;QACAE;QACAC;QACAC;QACAC;QACAC;QACAC;QACAE;QACAE;QAGAC;QAGAC;QACAC;QAGAE;QACAC;QACAC;QACAC;QACAC;QACAE;;IAGA,MAAM,CAACE,UAAUC,YAAY,GAAGC,OAAMC,QAAQ,CAAwB;IAEtE,MAAM,EAAEC,eAAe,EAAEC,WAAW,EAAE,GAAGC,IAAAA,yCAA+B,EAAC;QACvE9B,WAAWC;QACXC;QACAI;QACAkB;QACAjB;QACAE;QACAL;QACAC;QACAF;QACAQ;IACF;IAEA,MAAM,EACJoB,GAAGC,aAAa,EAChBC,GAAGC,aAAa,EAChBC,UAAUC,wBAAwB,EAClCpC,WAAWqC,iBAAiB,EAC5BC,IAAI,EACJC,cAAc,EACf,GAAGC,IAAAA,qBAAW,EAAC;QACdxC,WAAW4B;QACXa,YAAYZ;QACZa,sBAAqB,GAAGC,IAAI;YAC1B,+CAA+C,GAC/C,OAAOC,IAAAA,mCAAyB,KAAID,MAAM;gBACxCE,eAAejC;YACjB;QACF;IACF;IACA,MAAM,EAAEN,OAAOwC,WAAW,EAAE,GAAGP;IAE/B,MAAMQ,gBAAgBC,IAAAA,0BAAY,EAAiBV,KAAKW,WAAW,EAAEhC;IAErEiC,IAAAA,oDAAyB,EAAC;QACxBZ,KAAKa,YAAY,CAAC,aAAanC,YAAYA,UAAUoC,OAAO,GAAGpC;IACjE,GAAG;QAACsB,KAAKa,YAAY;QAAEnC;KAAU;IAEjC,MAAMqC,wBAAwBC,IAAAA,wBAAW,EAACjB;IAC1Ca,IAAAA,oDAAyB,EAAC;QACxB,IAAIG,0BAA0BE,aAAa,CAACjC,mBAAmB;YAC7D;QACF;QACA,IAAI+B,0BAA0BhB,mBAAmB;YAC/Cf,kBAAkBe;QACpB;IACF,GAAG;QAACgB;QAAuBhB;QAAmBf;KAAkB;IAEhE,MAAMkC,yBACJ,qBAACC,4BAAa,8CACRlC;QACJmC,aAAa;QACbzC,YAAY8B;QACZ3B,OAAO,qBACFC,WACAsC,IAAAA,iDAAuC,EACxCvB,0BACAJ,eACAE,eACAhC,YAAY,OAAOqD,WACnBhB;QAIHjC,uBACC,qBAACsD,4BAAa,8CACR/C;QACJgD,QAAQf;QACR9C,WAAWqC;QACXpB,YAAYQ;QACZqC,MAAMhD;SAGTI;IAIL,qBAAO,qBAAC6C,4BAAa;QAAC5C,WAAWA;OAAYqC;AAC/C"}